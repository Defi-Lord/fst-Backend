// prisma/schema.prisma

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// ─── USER + WALLET SYSTEM ────────────────────────────────────────────────
//
model User {
  id           String             @id @default(auto()) @map("_id") @db.ObjectId
  telegramId   String?            @unique
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  displayName  String?
  wallet       Wallet?            @relation(fields: [walletId], references: [id])
  walletId     String?            @unique
  role         Role               @default(USER)

  entries      ContestEntry[]
  teams        Team[]
  adminActions AdminAction[]
  leaderboard  LeaderboardEntry[]
}

model Wallet {
  id        String         @id @default(auto()) @map("_id") @db.ObjectId
  address   String         @unique
  nonce     String?
  createdAt DateTime       @default(now())

  users     User[]
  txs       Transaction[]
}

model Transaction {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  wallet      Wallet?    @relation(fields: [walletId], references: [id])
  walletId    String?
  txSignature String     @unique
  amount      Float
  confirmed   Boolean    @default(false)
  createdAt   DateTime   @default(now())
}

//
// ─── NONCE MODEL ────────────────────────────────────────────────
//
model Nonce {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  address   String   @unique
  nonce     String
  createdAt DateTime @default(now())
}

enum Role {
  USER
  ADMIN
}

//
// ─── CONTEST SYSTEM ─────────────────────────────────────────────────────
//
model Contest {
  id               String             @id @default(auto()) @map("_id") @db.ObjectId
  slug             String             @unique
  title            String
  realm            Realm
  status           ContestStatus      @default(OPEN)
  entryFee         Float              @default(0)
  registrationOpen Boolean            @default(true)
  playersLimit     Int?
  prizePoolCents   Int                @default(0)

  payoutRules      PayoutRule[]
  entries          ContestEntry[]
  leaderboard      LeaderboardEntry[]
  teams            Team[]

  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
}

enum ContestStatus {
  OPEN
  CLOSED
  SETTLED
}

enum Realm {
  FREE
  WEEKLY
  MONTHLY
  SEASONAL
}

model PayoutRule {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  contestId String?
  contest   Contest? @relation(fields: [contestId], references: [id])
  rank      Int
  percent   Float
}

model ContestEntry {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?
  user        User?      @relation(fields: [userId], references: [id])
  contestId   String?
  contest     Contest?   @relation(fields: [contestId], references: [id])
  address     String
  paid        Boolean    @default(false)
  txSignature String?
  amount      Float?
  joinedAt    DateTime   @default(now())
  createdAt   DateTime   @default(now())

  // ✅ Compound unique index for upsert (matches contests.ts)
  @@unique([userId, contestId], name: "user_contest_unique")
}

model Team {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?
  user      User?      @relation(fields: [userId], references: [id])
  contestId String?
  contest   Contest?   @relation(fields: [contestId], references: [id])
  realm     Realm
  playerIds String[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model LeaderboardEntry {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  contestId String?
  contest   Contest?   @relation(fields: [contestId], references: [id])
  userId    String?
  user      User?      @relation(fields: [userId], references: [id])
  points    Int        @default(0)
  rank      Int?
  updatedAt DateTime   @updatedAt
}

model AdminAction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  adminId   String?
  admin     User?    @relation(fields: [adminId], references: [id])
  action    String
  meta      Json?
  createdAt DateTime @default(now())
}
