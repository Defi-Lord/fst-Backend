// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id           String             @id @default(cuid())
  telegramId   String?            @unique
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  displayName  String?
  wallet       Wallet?            @relation(fields: [walletId], references: [id])
  walletId     String?            @unique
  role         Role               @default(USER)
  entries      ContestEntry[]
  teams        Team[]
  adminActions AdminAction[]
  leaderboard  LeaderboardEntry[]
}

model Wallet {
  id        String   @id @default(cuid())
  address   String   @unique
  nonce     String?
  createdAt DateTime @default(now())
  users     User[]
  txs       Transaction[]
}

model Transaction {
  id          String   @id @default(cuid())
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  walletId    String
  txSignature String   @unique
  amount      Float
  confirmed   Boolean  @default(false)
  createdAt   DateTime @default(now())
}

enum Role {
  USER
  ADMIN
}

model Contest {
  id             String             @id @default(cuid())
  slug           String             @unique
  title          String
  realm          Realm
  status         ContestStatus      @default(OPEN)
  entryFee       Float              @default(0)
  registrationOpen Boolean          @default(true)
  playersLimit   Int
  prizePoolCents Int                @default(0)
  payoutRules    PayoutRule[]
  entries        ContestEntry[]
  leaderboard    LeaderboardEntry[]
  teams          Team[]
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
}

enum ContestStatus {
  OPEN
  CLOSED
  SETTLED
}

enum Realm {
  FREE
  WEEKLY
  MONTHLY
  SEASONAL
}

model PayoutRule {
  id        String  @id @default(cuid())
  contest   Contest @relation(fields: [contestId], references: [id])
  contestId String
  rank      Int
  percent   Float
  @@unique([contestId, rank])
}

model ContestEntry {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  contest     Contest  @relation(fields: [contestId], references: [id])
  contestId   String
  address     String
  paid        Boolean  @default(false)
  txSignature String?
  amount      Float?
  createdAt   DateTime @default(now())
  @@unique([userId, contestId])
}

model Team {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  contest   Contest? @relation(fields: [contestId], references: [id])
  contestId String?
  realm     Realm
  playerIds String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@index([userId, realm])
}

model LeaderboardEntry {
  id        String   @id @default(cuid())
  contest   Contest  @relation(fields: [contestId], references: [id])
  contestId String
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  points    Int      @default(0)
  rank      Int?
  updatedAt DateTime @updatedAt
  @@unique([contestId, userId])
}

model AdminAction {
  id        String   @id @default(cuid())
  admin     User     @relation(fields: [adminId], references: [id])
  adminId   String
  action    String
  meta      Json?
  createdAt DateTime @default(now())
}
